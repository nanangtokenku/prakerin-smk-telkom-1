{
  "version": 3,
  "sources": ["../../@harlem/extension-storage/dist/index.bundler.mjs"],
  "sourcesContent": ["// src/constants.ts\nvar SENDER = \"extension:storage\";\nvar MUTATIONS = {\n  sync: \"extension:storage:sync\"\n};\n\n// src/index.ts\nimport {\n  EVENTS\n} from \"@harlem/core\";\nimport {\n  functionIdentity,\n  matchGetFilter,\n  objectFromPath,\n  objectSet,\n  objectTrace,\n  typeIsNil\n} from \"@harlem/utilities\";\nfunction getOptions(options) {\n  return {\n    type: \"local\",\n    prefix: \"harlem\",\n    sync: true,\n    restore: false,\n    include: \"*\",\n    exclude: [],\n    serialiser: (state) => JSON.stringify(state),\n    parser: (value) => JSON.parse(value),\n    branch: functionIdentity,\n    ...options\n  };\n}\nfunction storageExtension(options) {\n  const _options = getOptions(options);\n  const {\n    type,\n    prefix,\n    sync,\n    restore,\n    include,\n    exclude,\n    serialiser,\n    parser,\n    branch\n  } = _options;\n  return (store) => {\n    if (store.flags.has(\"ssr:server\")) {\n      const noop = () => {\n      };\n      return {\n        startStorageSync: noop,\n        stopStorageSync: noop,\n        clearStorage: noop,\n        restoreStorage: noop\n      };\n    }\n    store.register(\"extensions\", \"storage\", () => _options);\n    const {\n      value,\n      getNodes,\n      resetNodes\n    } = objectTrace();\n    const storage = type === \"session\" ? sessionStorage : localStorage;\n    const storageKey = prefix ? `${prefix}:${store.name}` : store.name;\n    const mutationFilter = matchGetFilter({\n      include,\n      exclude\n    });\n    resetNodes();\n    branch(value);\n    function startStorageWrite() {\n      store.on(EVENTS.mutation.success, (event) => {\n        if (!event || event.data.name === MUTATIONS.sync || !mutationFilter(event.data.name)) {\n          return;\n        }\n        try {\n          const state = objectFromPath(store.state, getNodes());\n          storage.setItem(storageKey, serialiser(state));\n        } catch (e) {\n          console.warn(\"Failed to write to storage\");\n        }\n      });\n    }\n    function syncStorage(value2) {\n      store.write(MUTATIONS.sync, SENDER, (state) => objectSet(state, getNodes(), parser(value2)));\n    }\n    function listener({ key, storageArea, newValue }) {\n      if (storageArea === storage && key === storageKey && newValue) {\n        syncStorage(newValue);\n      }\n    }\n    function startStorageSync() {\n      window.addEventListener(\"storage\", listener);\n    }\n    function stopStorageSync() {\n      window.removeEventListener(\"storage\", listener);\n    }\n    function clearStorage() {\n      storage.removeItem(storageKey);\n    }\n    function restoreStorage() {\n      const value2 = storage.getItem(storageKey);\n      if (!typeIsNil(value2)) {\n        syncStorage(value2);\n      }\n    }\n    store.once(EVENTS.store.created, () => {\n      startStorageWrite();\n      if (sync) {\n        startStorageSync();\n      }\n      if (restore) {\n        restoreStorage();\n      }\n    });\n    store.once(EVENTS.store.destroyed, () => stopStorageSync());\n    return {\n      startStorageSync,\n      stopStorageSync,\n      clearStorage,\n      restoreStorage\n    };\n  };\n}\nexport {\n  storageExtension as default\n};\n"],
  "mappings": "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",
  "names": []
}
