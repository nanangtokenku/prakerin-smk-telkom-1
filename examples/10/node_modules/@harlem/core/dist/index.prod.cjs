"use strict";var K=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var st=Object.prototype.hasOwnProperty;var at=(e,c)=>{for(var u in c)K(e,u,{get:c[u],enumerable:!0})},it=(e,c,u,v)=>{if(c&&typeof c=="object"||typeof c=="function")for(let y of ot(c))!st.call(e,y)&&y!==u&&K(e,y,{get:()=>c[y],enumerable:!(v=rt(c,y))||v.enumerable});return e};var ct=e=>it(K({},"__esModule",{value:!0}),e);var Tt={};at(Tt,{EVENTS:()=>n,INTERNAL:()=>et,PRODUCERS:()=>$,createInstance:()=>Z,createStore:()=>pt,createVuePlugin:()=>ft,off:()=>lt,on:()=>ut,once:()=>dt});module.exports=ct(Tt);function Q(){let e=new Map;function c(l,d){let f=e.get(l)||new Set;return f.add(d),e.set(l,f),{dispose:()=>u(l,d)}}function u(l,d){let f=e.get(l);!f||(f.delete(d),f.size||e.delete(l))}function v(l,d){let f=h=>{d(h),u(l,f)};return c(l,f)}function y(l,d){let f=e.get(l);f&&f.forEach(h=>h(d))}return{on:c,off:u,once:v,emit:y}}var tt=require("@harlem/utilities"),E="core",n={core:{installed:"core:installed"},store:{created:"store:created",ready:"store:ready",destroyed:"store:destroyed"},mutation:{before:"mutation:before",after:"mutation:after",success:"mutation:success",error:"mutation:error"},action:{before:"action:before",after:"action:after",success:"action:success",error:"action:error"},ssr:{initServer:"ssr:init:server",initClient:"ssr:init:client"},devtools:{update:"devtools:update",reset:"devtools:reset"}},X={snapshot:"core:snapshot",reset:"core:reset"},$={read:e=>e,write:e=>e,payload:e=>(0,tt.objectClone)(e)},et={prefix:"$harlem:",pattern:/^\$harlem:/};var A=require("vue"),m=require("@harlem/utilities");function nt(e,c){return u=>{u&&u.store===e&&c(u)}}function Y(e,c,u,v){var _;let{allowsOverwrite:y,producers:l}={allowsOverwrite:!0,...v,producers:{...$,...v==null?void 0:v.producers}},d={},f=new Map,h=(0,A.effectScope)(),a=new Set,i=!1,T=(0,A.reactive)(c),P=(0,A.readonly)(T),w;function M(t,r,s){if(!h.active||i)return;let p={data:s,sender:r,store:e};u.emit(t,p)}function o(t,r){return u.on(t,nt(e,r))}function D(t,r){return u.once(t,nt(e,r))}function R(t){return h.run(t)}function k(t,r){var s;return!!((s=d[t])!=null&&s.has(r))}function U(t,r){var s;return(s=d[t])==null?void 0:s.get(r)}function H(t,r,s,p="other"){if(!r)throw new Error("Registration name cannot be empty");if(t in d||(d[t]=new Map),!y&&k(t,r))throw new Error(`A ${t} named ${r} has already been registered on this store`);d[t].set(r,{type:p,producer:s})}function F(t,r){var s;(s=d[t])==null||s.delete(r)}function V(t){i=!0;try{return t()}finally{i=!1}}function G(t,r){let s=R(()=>(0,A.computed)(()=>r(P)));return H("getters",t,()=>s.value,"computed"),s}function j(t,r,s,p){var x,I;if(!h.active)throw new Error("The current store has been destroyed. Mutations can no longer take place.");if(a.has(t))throw new Error("Circular mutation reference detected. Avoid calling mutations inside other mutations to prevent circular references.");a.add(t);let g,b=S=>M(S,r,{name:t,payload:p,result:g});b(n.mutation.before);try{let S=(x=l.write(T))!=null?x:T,J=(I=l.payload(p))!=null?I:p;g=s(S,J),b(n.mutation.success)}catch(S){throw b(n.mutation.error),S}finally{a.delete(t),b(n.mutation.after)}return g}function W(t,r){let s=p=>j(t,E,r,p);return H("mutations",t,()=>s),s}function z(t,r){let s=g=>N(t,E,g),p=async g=>{var I;let b,x=S=>M(S,E,{name:t,payload:g,result:b});x(n.action.before);try{let S=(I=l.payload(g))!=null?I:g;b=await r(S,s),x(n.action.success)}catch(S){throw x(n.action.error),S}finally{x(n.action.after)}return b};return H("actions",t,()=>p),p}function L(){let t=(0,m.objectClone)(c),{value:r,getNodes:s,resetNodes:p}=(0,m.objectTrace)();return{apply:(b=m.functionIdentity,x=X.snapshot)=>{N(x,E,I=>{if(!t)return console.warn("Couldn't find snapshot for this operation!");p(),b(r);let S=s(),J=(0,m.objectFromPath)(t,S);(0,m.objectSet)(I,S,(0,m.objectClone)(J))})},get state(){return(0,m.objectClone)(t)}}}function O(t=m.functionIdentity){w==null||w.apply(t,X.reset)}function N(t,r,s,p){let g=()=>j(t,r,s,void 0);return p?V(g):g()}function q(){h.stop()}D(n.store.ready,()=>w=L()),o(n.devtools.reset,()=>O());let C=(_=l.read(P))!=null?_:P;return{name:e,allowsOverwrite:y,flags:f,producers:l,registrations:d,on:o,once:D,emit:M,state:C,getter:G,mutation:W,action:z,write:N,snapshot:L,reset:O,register:H,unregister:F,hasRegistration:k,getRegistration:U,track:R,suppress:V,destroy:q}}var B=require("@harlem/utilities");function Z(){let e=Q(),c=new Map,u=!1;function v(a){let i=c.get(a);if(i&&!i.allowsOverwrite)throw new Error(`A store named ${a} has already been registered.`)}function y(a,i){let T=()=>{a.emit(n.ssr.initClient,E,i),a.emit(n.store.created,E,i),a.emit(n.ssr.initServer,E,i),a.emit(n.store.ready,E,i),a.emit(n.devtools.update,E,i)};if(u)return T();e.once(n.core.installed,T)}function l(a,i){return i.reduce((T,P)=>{let w={};try{w=P(a)||{}}catch(M){w={}}return{...T,...w}},{})}function d(a,i){if(!(0,B.typeIsFunction)(a))return;let T=(0,B.objectLock)(c,["set","delete","clear"]);try{a(i,e,T)}catch(P){console.warn("Failed to install Harlem plugin. Skipping.")}}function f(a,i,T){let{allowsOverwrite:P,producers:w,extensions:M}={allowsOverwrite:!0,extensions:[],...T};v(a);let o=Y(a,i,e,{allowsOverwrite:P,producers:w}),D=()=>{c.delete(a),o.destroy(),o.emit(n.store.destroyed,E,i),o.emit(n.devtools.update,E,i)},R=L=>(O,N)=>{let q=(0,B.matchGetFilter)((0,B.typeIsMatchable)(O)?O:{include:O});return o.on(L,C=>{C&&q(C.data.name)&&N(C.data)})},k=R(n.mutation.before),U=R(n.mutation.after),H=R(n.mutation.success),F=R(n.mutation.error),V=R(n.action.before),G=R(n.action.after),j=R(n.action.success),W=R(n.action.error),z=l(o,M);return c.set(a,o),y(o,i),{destroy:D,onBeforeMutation:k,onAfterMutation:U,onMutationSuccess:H,onMutationError:F,onBeforeAction:V,onAfterAction:G,onActionSuccess:j,onActionError:W,state:o.state,getter:o.getter.bind(o),mutation:o.mutation.bind(o),action:o.action.bind(o),snapshot:o.snapshot.bind(o),reset:o.reset.bind(o),suppress:o.suppress.bind(o),on:o.on.bind(o),once:o.once.bind(o),...z}}function h(a){return{install(i){let{plugins:T}={plugins:[],...a};T&&T.forEach(P=>d(P,i)),u=!0,e.emit(n.core.installed)}}}return{createVuePlugin:h,createStore:f,on:e.on,once:e.once,off:e.off}}var{on:ut,off:lt,once:dt,createVuePlugin:ft,createStore:pt}=Z();window.$harlem={createInstance:Z};0&&(module.exports={EVENTS,INTERNAL,PRODUCERS,createInstance,createStore,createVuePlugin,off,on,once});
