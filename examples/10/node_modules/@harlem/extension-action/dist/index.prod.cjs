"use strict";var nt=Object.create;var S=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,at=Object.prototype.hasOwnProperty;var st=(n,r)=>{for(var o in r)S(n,o,{get:r[o],enumerable:!0})},G=(n,r,o,u)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of ot(r))!at.call(n,i)&&i!==o&&S(n,i,{get:()=>r[i],enumerable:!(u=rt(r,i))||u.enumerable});return n};var it=(n,r,o)=>(o=n!=null?nt(et(n)):{},G(r||!n||!n.__esModule?S(o,"default",{value:n,enumerable:!0}):o,n)),ct=n=>G(S({},"__esModule",{value:!0}),n);var lt={};st(lt,{ABORT_STRATEGY:()=>Y,ActionAbortError:()=>d,default:()=>_});module.exports=ct(lt);var E=it(require("@harlem/task"));var I="extension:action";var k=require("vue");function b(n,r){return`Action ${n} has been cancelled. Reason: ${r||"unknown"}`}var d=class extends Error{constructor(o,u,i){super(b(o,i));this.name=o,this.instanceId=u,this.reason=i}};var w=require("@harlem/core"),V=require("@harlem/utilities"),Y={error:(n,r,o,u,i)=>{u(new d(n,r,i))},warn:(n,r,o,u,i)=>{console.warn(b(n,i)),o()}};function ut(n){return{concurrent:!0,...n,strategies:{abort:Y.error,...n==null?void 0:n.strategies}}}function _(n){let r=ut(n);return o=>{o.register("extensions","action",()=>r);let u=new Map,i=(0,k.reactive)(new Map);function R(t){let a={runCount:0,instances:new Map,errors:new Map};return i.set(t,a),a}function A(t){return i.get(t)||R(t)}function H(t,a={}){o.register("actions",t,()=>a),R(t);let e=new Set;return u.set(t,e),{tasks:e}}function J(t,a,e){let{tasks:s}=H(t,e),{concurrent:l,autoClearErrors:p,strategies:T}={autoClearErrors:!0,...r,...e,strategies:{...r.strategies,...e==null?void 0:e.strategies}},f=g=>o.write(t,I,g),y=()=>A(t).runCount+=1;return(g,Z)=>{let{instances:O,errors:N}=A(t);(!l||(0,V.typeIsFunction)(l)&&!l(g,Array.from(O.values())))&&D(t,"New instance started on non-concurrent action"),p&&N.clear();let C=new E.default(async(F,z,tt,$)=>{var q;let P=Symbol(t),j=()=>(s.delete(C),O.delete(P)),M=c=>T.abort(t,P,F,z,c),v,m=c=>o.emit(c,I,{name:t,payload:g,result:v});$(c=>(j(),M(c))),O.set(P,g),m(w.EVENTS.action.before);try{let c=(q=o.producers.payload(g))!=null?q:g;v=await a(c,f,tt,$),m(w.EVENTS.action.success),y(),F(v)}catch(c){if(x(c))return M(c.message);if(c instanceof DOMException)return M("Network request cancelled");m(w.EVENTS.action.error),y(),N.set(P,c),z(c)}finally{m(w.EVENTS.action.after),j()}},Z);return s.add(C),C}}function B(t){return A(t).runCount>0}function h(t,a){let e=Array.from(A(t).instances.values());return!!e.length&&(!a||e.some(a))}function K(t){return!B(t)&&h(t)}function L(t,a,e){return new E.default((s,l,p,T)=>{let f=()=>!h(t,a);if(f())return s();let y=(0,k.watchEffect)(()=>{f()&&(y(),s())});T(()=>(y(),s()))},e)}function Q(t){return!!A(t).errors.size}function U(t){return Array.from(A(t).errors).map(([e,s])=>({id:e,error:s}))}function x(t){return t instanceof d}function W(t){[].concat(t||Array.from(i.keys())).forEach(a=>R(a))}function D(t,a){[].concat(t).forEach(e=>{let s=u.get(e);s!=null&&s.size&&s.forEach(l=>{l.abort(a),s.delete(l)})})}function X(t){return(a,e)=>new E.default(async(s,l,p,T)=>{T(()=>s());try{let f=await t(a,p);s(f)}catch(f){x(f)?s():l(f)}},e)}return{action:J,abortAction:D,getActionErrors:U,hasActionFailed:Q,hasActionRun:B,isActionAbortError:x,isActionFirstRun:K,isActionRunning:h,resetActionState:W,suppressAbortError:X,whenActionIdle:L}}}0&&(module.exports={ABORT_STRATEGY,ActionAbortError});
