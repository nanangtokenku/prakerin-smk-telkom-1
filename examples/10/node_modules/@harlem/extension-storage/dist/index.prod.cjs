"use strict";var f=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var M=(o,t)=>{for(var s in t)f(o,s,{get:t[s],enumerable:!0})},U=(o,t,s,c)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of J(t))!L.call(o,a)&&a!==s&&f(o,a,{get:()=>t[a],enumerable:!(c=A(t,a))||c.enumerable});return o};var $=o=>U(f({},"__esModule",{value:!0}),o);var K={};M(K,{default:()=>N});module.exports=$(K);var v="extension:storage",p={sync:"extension:storage:sync"};var l=require("@harlem/core"),r=require("@harlem/utilities");function G(o){return{type:"local",prefix:"harlem",sync:!0,restore:!1,include:"*",exclude:[],serialiser:t=>JSON.stringify(t),parser:t=>JSON.parse(t),branch:r.functionIdentity,...o}}function N(o){let t=G(o),{type:s,prefix:c,sync:a,restore:I,include:O,exclude:h,serialiser:w,parser:b,branch:P}=t;return n=>{if(n.flags.has("ssr:server")){let e=()=>{};return{startStorageSync:e,stopStorageSync:e,clearStorage:e,restoreStorage:e}}n.register("extensions","storage",()=>t);let{value:D,getNodes:u,resetNodes:F}=(0,r.objectTrace)(),S=s==="session"?sessionStorage:localStorage,g=c?`${c}:${n.name}`:n.name,R=(0,r.matchGetFilter)({include:O,exclude:h});F(),P(D);function j(){n.on(l.EVENTS.mutation.success,e=>{if(!(!e||e.data.name===p.sync||!R(e.data.name)))try{let i=(0,r.objectFromPath)(n.state,u());S.setItem(g,w(i))}catch(i){console.warn("Failed to write to storage")}})}function d(e){n.write(p.sync,v,i=>(0,r.objectSet)(i,u(),b(e)))}function y({key:e,storageArea:i,newValue:E}){i===S&&e===g&&E&&d(E)}function m(){window.addEventListener("storage",y)}function T(){window.removeEventListener("storage",y)}function B(){S.removeItem(g)}function x(){let e=S.getItem(g);(0,r.typeIsNil)(e)||d(e)}return n.once(l.EVENTS.store.created,()=>{j(),a&&m(),I&&x()}),n.once(l.EVENTS.store.destroyed,()=>T()),{startStorageSync:m,stopStorageSync:T,clearStorage:B,restoreStorage:x}}}0&&(module.exports={});
